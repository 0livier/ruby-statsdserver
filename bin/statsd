#!/usr/bin/env ruby


require "rubygems"
require "bundler/setup"

require "parseconfig"
require "statsdserver"
require "statsdserver/output/stdout"
require "statsdserver/output/tcp"
require "sysexits"

include Sysexits
progname = File.basename($0)

if ARGV.length != 1
  $stderr.puts "usage: #{progname} path_to_config"
  exit EX_USAGE
end

config_path = ARGV.shift
begin
  config_file = ParseConfig.new(config_path)
rescue
  $stderr.puts "#{progname}: error reading #{config_path}: #{$!}"
  exit EX_DATAERR
end

config = {}
%w(daemonize inputs flush_interval outputs prefix percentile
   suffix preserve_counters).each do |key|
  config[key.to_sym] = config_file[key] if config_file[key]
end

if config[:inputs].nil? || config[:inputs].empty?
  $stderr.puts "#{progname}: no inputs specified"
  exit EX_DATAERR
end

if config[:outputs].nil? || config[:outputs].empty?
  $stderr.puts "#{progname}: no outputs specified"
  exit EX_DATAERR
end

input_config = {}
config[:inputs].split(/, */).each do |input|
  input_config[input] = config_file["input:#{input}"] || {}
end

output_config = {}
config[:outputs].split(/, */).each do |output|
  output_config[output] = config_file["output:#{output}"] || {}
end

EM.run do
  s = StatsdServer.new(config, input_config, output_config)
  s.run
end
